<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>GPT 利用レポート</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        form { margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; }
        .btn { display: inline-block; padding: 0.5rem 1.2rem; margin-top: 0.5rem; background: #0066cc; color: #fff; text-decoration: none; border-radius: 4px; }
        .btn:hover { background: #004999; }
        .message { padding: 0.75rem 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .error { background: #ffeaea; border: 1px solid #d33; color: #900; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
        th { background: #f5f5f5; }
        .download-links { margin-top: 1rem; }
    </style>
</head>
<body>
    <h1>ChatGPT 利用スコア レポート</h1>
    <p>ChatGPT の利用履歴 JSON をアップロードすると、ユーザーごとのスコアを計算して CSV を生成します。</p>

    <form method="post" enctype="multipart/form-data">
        <label for="files">JSON ファイルを選択（複数可）:</label><br>
        <input type="file" id="files" name="files" multiple accept=".json">
        <br>
        <button type="submit" class="btn">レポート生成</button>
    </form>

    {% if errors %}
        <div class="message error">
            <ul>
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% if report_df is not none and not report_df.empty %}
        <div class="download-links">
            {% if csv_data_uri %}
                <a class="btn" href="{{ csv_data_uri }}" download="summary_report.csv">summary_report.csv をダウンロード</a>
            {% endif %}
        </div>

        <table>
            <thead>
                <tr>
                    {% for header in headers %}
                        <th>{{ header_labels[header] }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for _, row in report_df.iterrows() %}
                    <tr>
                        {% for header in headers %}
                            {% set value = row[header] %}
                            <td>
                                {% if header in ["avg_turns", "total_minutes", "score"] %}
                                    {{ "{:.2f}".format(value) }}
                                {% elif header == "paid_flag" %}
                                    {{ "はい" if value else "いいえ" }}
                                {% else %}
                                    {{ value }}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% elif report_df is not none %}
        <div class="message error">解析対象の会話が見つかりませんでした。</div>
    {% endif %}
</body>
</html>
